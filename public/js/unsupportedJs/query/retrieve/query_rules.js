function rulesInit(){var m=Array();var f=$("[data-idBlock=rules]");var n=false;var l;$("#blocks").on("panelDidAppear",function(o,p){if(p.blockId()=="rules"&&typeof(queryObject)!="undefined"){if(!n||l!=queryObject.get("datastore").id){j()}}});g();i();k();c();var d=0;function j(){n=true;l=queryObject.get("datastore").id;f.find(".rulesLoading").animate({opacity:1},200);f.find(".rules").animate({opacity:0},function(){f.find(".rules").html("");f.find(".rules").animate({opacity:1},200);function p(){var q=new Parse.Promise();queryH.createQueryRuleGroup(queryObject.id,undefined,"and",{success:function(r){queryObject.set("masterRulesGroup",r);queryObject.save({success:function(s){queryObject=s;q.resolve()},error:function(s){new ModalErrorParse(s)}})},error:function(r){new ModalErrorParse(r)}});return q}var o=Parse.Promise.as();o=o.then(function(){if(typeof(queryObject.get("masterRulesGroup"))!="undefined"){return queryObject.get("masterRulesGroup").fetch({success:function(q){if(!q){return p()}},error:function(r,q){if(typeof(q)!="undefined"){if(typeof(q.code)!="undefined"){if(q.code==101){return p().then(function(){return e(queryObject.get("masterRulesGroup")).then(function(){f.find(".rulesLoading").animate({opacity:0},200)})})}}}}})}else{return p()}}).then(function(){e(queryObject.get("masterRulesGroup")).then(function(){f.find(".rulesLoading").animate({opacity:0},200)})})})}function e(q){var o=new Parse.Promise();var p=q;var r=Parse.Promise.as();r=r.then(function(){if(typeof(p.get("rules"))=="undefined"){return p.fetch({success:function(s){p=s}})}}).then(function(){var t=$("#groupPattern").clone();t.removeClass("hidden");t.css("opacity","0");t.attr("id","");t.attr("data-id",p.id);t.attr("data-andor",p.get("andOrValue"));if(typeof(p.get("parent"))!="undefined"){t.attr("parent-query-id",p.get("parent").id)}if(typeof(p.get("parent"))!="undefined"){t.insertAfter(f.find(".rules").find(".ruleRow[data-id="+p.get("parent").id+"]"))}else{if(f.find(".rules").find(".group").length){f.find(".rules").find(".group").first().append(t)}else{f.find(".rules").append(t)}}t.animate({opacity:1},200);var u=f.find("#addNewRulePattern").clone();u.removeClass("hidden");u.attr("id","");u.css("opacity","0");t.append(u);a(u.find("input"));window.setTimeout(function(){u.animate({opacity:1},200)},400);var s=p.relation("rules").query();s.ascending("createdAt");return s.find({success:function(v){var w=Parse.Promise.as();_.each(v,function(x){w=w.then(function(){return b(x,p)})});return w},error:function(v){console.log(v)}}).then(function(){o.resolve()})});return o}function b(s,r){var u=new Parse.Promise();var q=s;var v;var o;var t;var p=Parse.Promise.as();p=p.then(function(){if(typeof(q.get("value"))!="undefined"){var w=new Parse.Query("QueryRulesValue");w.equalTo("objectId",q.get("value").id);w.include("valueField");w.include("valueField.table");w.include("valueQuery");return w.first({success:function(x){v=x}})}}).then(function(){var w=new Parse.Query("QueryRules");w.equalTo("objectId",q.id);w.include("field");w.include("field.table");return w.first({success:function(x){q=x},error:function(x){console.log(x)}})}).then(function(){var z="";if(typeof(v)!="undefined"){if(v.get("type")=="group"){z="continueWithGroup"}else{if(v.get("type")=="constant"||v.get("type")=="variable"||v.get("type")=="field"){z="displayRule"}}}else{z="displayRule"}switch(z){case"continueWithGroup":return e(v.get("valueQueryRuleGroup"));break;case"displayRule":var w=f.find("#rulePattern").clone();w.removeClass("hidden");w.attr("id","rule"+q.id);w.attr("data-id",q.id);if(typeof(q.get("field"))!="undefined"){w.attr("data-field-id",q.get("field").id)}w.attr("data-rule",q.get("rule"));var x="<span class='dataType'>"+q.get("field").get("type")+"</span>";if(q.get("field").get("table")!==undefined){x+="<span class='tableName'>"+q.get("field").get("table").get("name")+"</span>."}else{x+="<span class='tableName'>undefinedTable</span>."}x+="<span class='fieldName'>"+q.get("field").get("name")+"</span>";w.find(".field").html(x);var F=f.find("#dataType_rules").find("."+q.get("field").get("type")).clone();if(F){F.removeClass("hidden");F.val(q.get("rule"));var B=F.find("option:selected").attr("data-target-available");if(B=="false"){w.find(".value").animate({opacity:0},200);w.find(".value").addClass("hidden")}else{if(q.get("field").get("type")=="date"){w.find(".value").find("input").datetimepicker({keepOpen:true});w.addClass("date").addClass("input-group")}}w.find(".rule").html(F)}else{alert("Error. You cannot apply a rule on this data field type")}var C=w.find(".value");if(typeof(v)!="undefined"){C.attr("data-id",v.id);var y="";var E="";switch(v.get("type")){case"constant":if(typeof(v.get("valueConstant"))!="undefined"){y="<span class='type'>Constant</span><span class='value'>"+v.get("valueConstant")+"</span>";E=v.get("valueConstant")}else{y="<span class='type'>Constant</span><span class='value'>Set value</span>";E=""}break;case"variable":if(typeof(v.get("valueConstant"))!="undefined"){y="<span class='type'>Variable</span><span class='value'>"+v.get("valueConstant")+"</span>";E=v.get("valueConstant")}else{y="<span class='type'>Variable</span><span class='value'>Set variable name</span>";E=""}break;case"field":if(typeof(v.get("valueField"))!="undefined"){y="<span class='type'>Variable</span><span class='table'>"+v.get("valueField").get("table").get("name")+"</span>.<span class='value'>"+v.get("valueField").get("name")+"</span>";E=v.get("valueField").get("name")}else{y="<span class='type'>Variable</span><span class='table'>&nbsp;</span>.<span class='value'>Set field name</span>";E=""}break}C.find(".valueContainer").html(y);C.find("input").val(E);C.find(".input select").val(v.get("type"))}var A=f.find(".rules").find(".group[data-id="+r.id+"]");if(A.find(".ruleRow").length>0){var D=f.find("#andOrBadge").clone();D.removeClass("hidden");D.attr("id","");D.attr("data-parentForRemoving",A.find(".ruleRow").last().attr("data-id"));D.find(".andOrBadge .value").text(A.attr("data-andor").toUpperCase());D.css("opacity","0");D.insertAfter(A.find(".ruleRow").last());window.setTimeout(function(){D.animate({opacity:1})},200)}w.css("opacity","0");w.insertBefore(A.find(".ruleAdd"));w.animate({opacity:1},200);break}u.resolve()});return u}function a(r){r.typeahead("destroy");var p=queryObject.get("datastore").id;var q;if(typeof String.prototype.startsWith!="function"){String.prototype.startsWith=function(s){return this.slice(0,s.length)==s}}function o(t,s){return JSON.stringify(t)==JSON.stringify(s)}databaseH.schema(p,{success:function(z){q=z;var y=Array();var x=Array();for(var v=0;v<q.data.length;v++){var u=q.data[v];var s=Array();for(var t=0;t<u.fields.length;t++){s.push({value:u.fields[t]})}s.push({value:u.table+".datumName"});var w=new Bloodhound({name:u.table,local:s,datumTokenizer:function(A){return Array(A.value)},queryTokenizer:function(F){function H(I){for(var J=0;J<x.length;J++){var K=x[J];if(o(K.fields,I)){return K.name}}}function C(L){var J=Array();var K=H(L);for(var M=0;M<L.length;M++){var I=L[M];J.push(I)}return J}var G=Array();var E=C(this.datums);for(var B=0;B<E.length;B++){var D=E[B];if(D.value.startsWith(F)){if(D.value.indexOf(".datumName")==-1){G.push(D.value)}}}if(!G.length){var A=H(this.datums);if(A.startsWith(F)){for(var B=0;B<E.length;B++){var D=E[B];if(D.value.indexOf(".datumName")==-1){G.push(D.value)}}}}return G},});w.initialize();x.push({fields:w.local,name:u.table});y.push({name:u.table,source:w.ttAdapter(),displayKey:"value",templates:{header:"<div class='tt-section-header'>"+u.table+"</div>"}})}r.typeahead({highlight:true,hint:true},y)}});$(document).on("typeahead:opened",r,function(){panelFlow.arrowKeysActivation(false)});$(document).on("typeahead:closed",r,function(){panelFlow.arrowKeysActivation(true)})}function i(){$(document).on("change","[data-idBlock=rules] .ruleRow select",function(){var u=$(this);var t=u.closest(".ruleRow");var o=u.find("option:nth-child("+(u.prop("selectedIndex")+1)+")");var v=t.find(".value");var r=v.find("input").first();var s=v.find("select").first();var w=t.find(".valueContainer");var q=w.find(".type");var p=w.find(".value");if(o.attr("data-target-available")=="false"){v.animate({opacity:0},200);v.addClass("hidden")}else{v.removeClass("hidden");v.animate({opacity:1},200)}})}function k(){$(document).on("typeahead:selected typeahead:autocompleted","[data-idBlock=rules] .group .ruleAdd input",function(q,o,r){if($(this).closest(".bigBackground").attr("data-idBlock")=="rules"){var p=$(this);f.find(".rulesLoading").animate({opacity:1},200);var s=undefined;if(typeof(p.closest(".group").attr("parent-query-id"))!="undefined"){s=p.closest(".group").attr("parent-query-id")}p.val("");queryH.createUpdateRule({query:queryObject.id,field:{datastore:queryObject.get("datastore").id,table:r,field:o.value},rule:undefined,parendId:s,valueId:undefined},{success:function(t){queryH.moveRuleToOtherGroup(undefined,p.closest(".group").attr("data-id"),t.id,{success:function(){j();f.find(".rulesLoading").animate({opacity:0},200)},error:function(u){new ModalErrorParse(u);f.find(".rulesLoading").animate({opacity:0},200)}})},error:function(t){new ModalErrorParse(t);f.find(".rulesLoading").animate({opacity:0},200)}})}})}function g(){$(document).on("click","[data-idBlock=rules] .ruleRow .remove",function(){var p=$(this).closest(".ruleRow");var o=p.attr("data-id");p.animate({opacity:0.2},200);queryH.removeRule(o,{success:function(){queryObject.fetch({success:function(q){queryObject=q;if(p.parent().find(".ruleRow").length>1){p.parent().find(".row[data-parentForRemoving="+p.attr("data-id")+"]").slideUp(function(){$(this).remove()});p.slideUp(function(){$(this).remove()});if(p.parent().find(".ruleRow").length==2){p.parent().find(".row").slideUp(function(){$(this).remove()})}}else{j()}}})},error:function(q){new ModalErrorParse(q)}})})}function c(){$(document).on("change","[data-idBlock=rules] .ruleRow .value input, [data-idBlock=rules] .ruleRow .value select",function(){f.find(".rulesLoading").animate({opacity:1},200);var q;var o;if($(this).is("select")){q=$(this).parent().find("input");o=$(this);q.val("")}else{q=$(this);q.val(q.val().replace(/ /g,"").replace(/\./g,"").replace(/\&/g,"").replace(/\//g,"").replace(/\\/g,"").replace(/,/g,""));o=$(this).parent().find("select")}var s=q.closest(".ruleRow");var r=s.attr("data-id");var t=queryObject.id;switch(o.val()){case"constant":case"variable":if(!q.val().length){s.find(".value .valueContainer").html('<span class="type">'+o.find("option:selected").text()+'</span><span class="value">&nbsp;</span>')}else{s.find(".value .valueContainer").html('<span class="type">'+o.find("option:selected").text()+'</span><span class="value">'+q.val()+"</span>")}s.find(".value .input input").attr("data-idField","");s.find(".value .input input").attr("placeholder","Type the value");var u={type:o.val(),value:q.val(),ruleId:r,queryId:t};if(typeof(s.find(".value").attr("data-id"))!="undefined"){u.valueId=s.find(".value").attr("data-id")}break;case"field":s.find(".value .valueContainer").html('<span class="type">'+o.find("option:selected").text()+"</span>");var p=false;if(typeof(s.find(".value .input input").attr("data-idField"))!="undefined"){if(s.find(".value .input input").attr("data-idField").length>0){p=true;s.find(".value .valueContainer").append('<span class="table"> </span><span class="value"> </span>')}}if(!p){s.find(".value .valueContainer").append('<span class="table">Select field</span>')}s.find(".value .input input").attr("placeholder","Type field name");var u={type:o.val(),value:q.attr("data-idField"),ruleId:r,queryId:t};if(typeof(s.find(".value").attr("data-id"))!="undefined"){u.valueId=s.find(".value").attr("data-id")}break}queryH.createUpdateRuleValue(u,{success:function(){f.find(".rulesLoading").animate({opacity:0},200)},error:function(v){f.find(".rulesLoading").animate({opacity:0},200);new ModalErrorParse(v)}})});$(document).on("change","[data-idBlock=rules] .ruleRow .dataTypeRule",function(){f.find(".rulesLoading").animate({opacity:1},200);var o=$(this);var q=o.closest(".ruleRow");var p=q.attr("data-id");var r=queryObject.id;queryH.createUpdateRule({query:queryObject.id,field:undefined,ruleId:p,rule:o.val(),parendId:undefined,valueId:undefined},{success:function(s){f.find(".rulesLoading").animate({opacity:0},200)},error:function(s){new ModalErrorParse(s);f.find(".rulesLoading").animate({opacity:0},200)}})})}function h(r,p){switch(p){case"number":var q=/^-?\d*\.?\d*$/;var o=new RegExp(q);return o.test(r);break;case"string":return(typeof(r)=="string");break;default:return true}}};