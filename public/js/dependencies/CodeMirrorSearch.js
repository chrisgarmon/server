dependenciesLoader(["CodeMirror"],function(){!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],a):a(CodeMirror)}(function(M){function E(a,c){return"string"==typeof a?a=new RegExp(a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),c?"gi":"g"):a.global||(a=new RegExp(a.source,a.ignoreCase?"gi":"g")),{token:function(d){a.lastIndex=d.pos;var e=a.exec(d.string);return e&&e.index==d.pos?(d.pos+=e[0].length||1,"searching"):void (e?d.pos=e.index:d.skipToEnd())}}}function F(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function z(a){return a.state.search||(a.state.search=new F)}function B(a){return"string"==typeof a&&a==a.toLowerCase()}function I(a,c,d){return a.getSearchCursor(c,d,B(c))}function P(c,d,f,a){c.openDialog(d,a,{value:f,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){b(c)}})}function O(d,f,g,a,c){d.openDialog?d.openDialog(f,c,{value:a,selectValueOnOpen:!0}):c(prompt(g,a))}function A(c,d,f,a){c.openConfirm?c.openConfirm(d,a):confirm(f)&&a[0]()}function H(a){return a.replace(/\\(.)/g,function(c,d){return"n"==d?"\n":"r"==d?"\r":d})}function w(a){var c=a.match(/^\/(.*)\/([a-z]*)$/);if(c){try{a=new RegExp(c[1],-1==c[2].indexOf("i")?"":"i")}catch(d){}}else{a=H(a)}return("string"==typeof a?""==a:a.test(""))&&(a=/x^/),a}function L(c,d,a){d.queryText=a,d.query=w(a),c.removeOverlay(d.overlay,B(d.query)),d.overlay=E(d.query,B(d.query)),c.addOverlay(d.overlay),c.showMatchesOnScrollbar&&(d.annotate&&(d.annotate.clear(),d.annotate=null),d.annotate=c.showMatchesOnScrollbar(d.query,B(d.query)))}function D(f,g,e){var c=z(f);if(c.query){return N(f,g)}var d=f.getSelection()||c.lastQuery;if(e&&f.openDialog){var a=null;P(f,J,d,function(i,h){M.e_stop(h),i&&(i!=c.queryText&&L(f,c,i),a&&(a.style.opacity=1),N(f,h.shiftKey,function(m,o){var l;o.line<3&&document.querySelector&&(l=f.display.wrapper.querySelector(".CodeMirror-dialog"))&&l.getBoundingClientRect().bottom-4>f.cursorCoords(o,"window").top&&((a=l).style.opacity=0.4)}))})}else{O(f,J,"Search for:",d,function(h){h&&!c.query&&f.operation(function(){L(f,c,h),c.posFrom=c.posTo=f.getCursor(),N(f,g)})})}}function N(c,d,a){c.operation(function(){var e=z(c),f=I(c,e.query,d?e.posFrom:e.posTo);(f.find(d)||(f=I(c,e.query,d?M.Pos(c.lastLine()):M.Pos(c.firstLine(),0)),f.find(d)))&&(c.setSelection(f.from(),f.to()),c.scrollIntoView({from:f.from(),to:f.to()},20),e.posFrom=f.from(),e.posTo=f.to(),a&&a(f.from(),f.to()))})}function b(a){a.operation(function(){var c=z(a);c.lastQuery=c.query,c.query&&(c.query=c.queryText=null,a.removeOverlay(c.overlay),c.annotate&&(c.annotate.clear(),c.annotate=null))})}function G(a,c,d){a.operation(function(){for(var e=I(a,c);e.findNext();){if("string"!=typeof c){var f=a.getRange(e.from(),e.to()).match(c);e.replace(d.replace(/\$(\d)/g,function(g,h){return f[h]}))}else{e.replace(d)}}})}function K(c,d){if(!c.getOption("readOnly")){var f=c.getSelection()||z(c).lastQuery,a=d?"Replace all:":"Replace:";O(c,a+k,a,f,function(e){e&&(e=w(e),O(c,j,"Replace with:","",function(h){if(h=H(h),d){G(c,e,h)}else{b(c);var i=I(c,e,c.getCursor()),g=function(){var n,m=i.from();!(n=i.findNext())&&(i=I(c,e),!(n=i.findNext())||m&&i.from().line==m.line&&i.from().ch==m.ch)||(c.setSelection(i.from(),i.to()),c.scrollIntoView({from:i.from(),to:i.to()}),A(c,C,"Replace?",[function(){l(n)},g,function(){G(c,e,h)}]))},l=function(m){i.replace("string"==typeof e?h:h.replace(/\$(\d)/g,function(p,q){return m[q]})),g()};g()}}))})}}var J='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',k=' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',j='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',C="Replace? <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>";M.commands.find=function(a){b(a),D(a)},M.commands.findPersistent=function(a){b(a),D(a,!1,!0)},M.commands.findNext=D,M.commands.findPrev=function(a){D(a,!0)},M.commands.clearSearch=b,M.commands.replace=K,M.commands.replaceAll=function(a){K(a,!0)}})});